<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Há»‡ thá»‘ng Quáº£n lÃ½ VÃ© TÃ u</title>
<style>
:root {
  --primary: #0078d7;
  --primary-dark: #005fa3;
  --secondary: #ff6b35;
  --light: #f8f9fa;
  --dark: #343a40;
  --success: #28a745;
  --danger: #dc3545;
  --warning: #ffc107;
  --gray: #6c757d;
  --light-gray: #eef2f3;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #eef2f3 0%, #d9e4f5 100%);
  margin: 0;
  min-height: 100vh;
  color: var(--dark);
}

.hidden { display: none; }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  text-align: center;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-radius: 0 0 15px 15px;
  margin-bottom: 30px;
}

header h1 {
  font-size: 2.2rem;
  margin-bottom: 10px;
}

header p {
  opacity: 0.9;
  font-size: 1.1rem;
}

/* Auth Screens */
.auth-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 70vh;
}

.auth-card {
  background: white;
  padding: 40px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 450px;
  text-align: center;
}

.auth-card h2 {
  color: var(--primary);
  margin-bottom: 10px;
  font-size: 1.8rem;
}

.auth-card p {
  color: var(--gray);
  margin-bottom: 30px;
}

.form-group {
  margin-bottom: 20px;
  text-align: left;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--dark);
}

.form-group input, .form-group select {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 120, 215, 0.2);
}

.btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: 12px 20px;
  margin: 5px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn-secondary {
  background: var(--secondary);
}

.btn-secondary:hover {
  background: #e55a2b;
}

.btn-success {
  background: var(--success);
}

.btn-success:hover {
  background: #218838;
}

.btn-danger {
  background: var(--danger);
}

.btn-danger:hover {
  background: #c82333;
}

.btn-warning {
  background: var(--warning);
  color: var(--dark);
}

.btn-warning:hover {
  background: #e0a800;
}

.btn-sm {
  padding: 8px 15px;
  font-size: 0.9rem;
}

/* Cards */
.card {
  background: white;
  padding: 25px;
  margin: 20px 0;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
}

.card h3 {
  color: var(--primary);
  margin-bottom: 20px;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

th, td {
  border: 1px solid #ddd;
  padding: 12px;
  text-align: left;
}

th {
  background: var(--primary);
  color: white;
  font-weight: 600;
}

tr:nth-child(even) {
  background-color: #f8f9fa;
}

tr:hover {
  background-color: #e9ecef;
}

/* Status badges */
.status-badge {
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-paid {
  background: #d1edff;
  color: #0056b3;
}

.status-confirmed {
  background: #d4edda;
  color: #155724;
}

.status-active {
  background: #d4edda;
  color: #155724;
}

.status-inactive {
  background: #f8d7da;
  color: #721c24;
}

/* Tabs */
.tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 1px solid #ddd;
  flex-wrap: wrap;
}

.tab {
  padding: 12px 20px;
  cursor: pointer;
  font-weight: 600;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
}

.tab.active {
  border-bottom: 3px solid var(--primary);
  color: var(--primary);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Stats */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  text-align: center;
}

.stat-card h4 {
  color: var(--gray);
  font-size: 1rem;
  margin-bottom: 10px;
}

.stat-card .value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

/* Payment methods */
.payment-methods {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin: 20px 0;
}

.payment-method {
  flex: 1;
  min-width: 150px;
  border: 2px solid #ddd;
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.payment-method:hover {
  border-color: var(--primary);
}

.payment-method.selected {
  border-color: var(--primary);
  background-color: rgba(0, 120, 215, 0.05);
}

.payment-method i {
  font-size: 2rem;
  margin-bottom: 10px;
  color: var(--primary);
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  transform: translateX(150%);
  transition: transform 0.4s ease;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: var(--success);
}

.notification.error {
  background: var(--danger);
}

.notification.info {
  background: var(--primary);
}

/* Loading */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Form Grid */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

/* Seat Selection */
.seat-map {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 10px;
  margin: 20px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
}

.seat {
  width: 40px;
  height: 40px;
  background: #28a745;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.seat:hover {
  transform: scale(1.1);
}

.seat.occupied {
  background: #dc3545;
  cursor: not-allowed;
}

.seat.selected {
  background: #ffc107;
  color: #000;
}

/* Responsive */
@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  .auth-card {
    padding: 25px;
  }
  
  .card {
    padding: 15px;
  }
  
  .stats-container {
    grid-template-columns: 1fr;
  }
  
  .payment-methods {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    margin: 5px 0;
  }
  
  .tabs {
    flex-direction: column;
  }
  
  .tab {
    text-align: center;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .seat-map {
    grid-template-columns: repeat(5, 1fr);
  }
}
</style>
</head>
<body>

<header>
  <h1>ğŸš† Há»† THá»NG QUáº¢N LÃ VÃ‰ TÃ€U</h1>
  <p>Äáº·t vÃ© nhanh chÃ³ng - Di chuyá»ƒn dá»… dÃ ng</p>
</header>

<div class="container">

<!-- ğŸ” ÄÄƒng nháº­p / ÄÄƒng kÃ½ -->
<div id="loginScreen">
  <div class="auth-container">
    <div class="auth-card">
      <h2>ÄÄƒng nháº­p há»‡ thá»‘ng</h2>
      <p>Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c sá»­ dá»¥ng dá»‹ch vá»¥</p>
      
      <div class="form-group">
        <label for="username">TÃªn Ä‘Äƒng nháº­p</label>
        <input id="username" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p" value="admin">
      </div>
      
      <div class="form-group">
        <label for="password">Máº­t kháº©u</label>
        <input id="password" type="password" placeholder="Nháº­p máº­t kháº©u" value="123">
      </div>
      
      <button class="btn" onclick="login()">ÄÄƒng nháº­p</button>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: var(--gray); margin-bottom: 15px;">ChÆ°a cÃ³ tÃ i khoáº£n?</p>
        <button class="btn btn-secondary" onclick="showRegister()">ÄÄƒng kÃ½ tÃ i khoáº£n má»›i</button>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: var(--gray); font-size: 0.9rem;">
          <strong>TÃ i khoáº£n demo:</strong><br>
          Quáº£n trá»‹ viÃªn: <strong>admin</strong> / <strong>123</strong><br>
          KhÃ¡ch hÃ ng: <strong>user</strong> / <strong>123</strong>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ“ ÄÄƒng kÃ½ -->
<div id="registerScreen" class="hidden">
  <div class="auth-container">
    <div class="auth-card">
      <h2>ÄÄƒng kÃ½ tÃ i khoáº£n</h2>
      <p>Táº¡o tÃ i khoáº£n má»›i Ä‘á»ƒ sá»­ dá»¥ng há»‡ thá»‘ng</p>
      
      <div class="form-group">
        <label for="regUsername">TÃªn Ä‘Äƒng nháº­p</label>
        <input id="regUsername" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p">
      </div>
      
      <div class="form-group">
        <label for="regPassword">Máº­t kháº©u</label>
        <input id="regPassword" type="password" placeholder="Nháº­p máº­t kháº©u">
      </div>
      
      <div class="form-group">
        <label for="regConfirmPassword">XÃ¡c nháº­n máº­t kháº©u</label>
        <input id="regConfirmPassword" type="password" placeholder="Nháº­p láº¡i máº­t kháº©u">
      </div>
      
      <div class="form-group">
        <label for="regFullName">Há» vÃ  tÃªn</label>
        <input id="regFullName" placeholder="Nháº­p há» vÃ  tÃªn">
      </div>
      
      <div class="form-group">
        <label for="regEmail">Email</label>
        <input id="regEmail" type="email" placeholder="Nháº­p Ä‘á»‹a chá»‰ email">
      </div>
      
      <div class="form-group">
        <label for="regPhone">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
        <input id="regPhone" placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i">
      </div>
      
      <button class="btn btn-success" onclick="register()">ÄÄƒng kÃ½</button>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: var(--gray);">ÄÃ£ cÃ³ tÃ i khoáº£n?</p>
        <button class="btn" onclick="showLogin()">Quay láº¡i Ä‘Äƒng nháº­p</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ‘¤ Giao diá»‡n khÃ¡ch hÃ ng -->
<div id="userScreen" class="hidden">
  <div class="card">
    <div class="card-header">
      <h3>Xin chÃ o, <span id="userName"></span>!</h3>
      <button class="btn btn-danger" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>
    <p>ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i há»‡ thá»‘ng Ä‘áº·t vÃ© tÃ u. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c chá»©c nÄƒng cÃ³ sáºµn:</p>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('datVeTab')">ğŸŸï¸ Äáº·t vÃ©</div>
    <div class="tab" onclick="switchTab('veDaDatTab')">ğŸ“‹ VÃ© Ä‘Ã£ Ä‘áº·t</div>
    <div class="tab" onclick="switchTab('thongTinTab')">ğŸ‘¤ ThÃ´ng tin</div>
  </div>

  <div id="datVeTab" class="tab-content active">
    <div class="card">
      <h3>ğŸŸï¸ Äáº·t vÃ© tÃ u</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="chonChuyen">Chá»n chuyáº¿n tÃ u</label>
          <select id="chonChuyen"></select>
        </div>
        <div class="form-group">
          <label for="soGhe">Sá»‘ gháº¿</label>
          <input id="soGhe" placeholder="VD: A01, B12" list="seatSuggestions">
          <datalist id="seatSuggestions">
            <option value="A01">
            <option value="A02">
            <option value="B01">
            <option value="B02">
            <option value="C01">
            <option value="C02">
          </datalist>
        </div>
      </div>
      
      <div class="form-group">
        <label for="giaVe">GiÃ¡ vÃ© (VNÄ)</label>
        <input id="giaVe" type="number" placeholder="Nháº­p giÃ¡ vÃ©" readonly>
      </div>
      
      <div id="seatSelection" class="hidden">
        <h4>Chá»n gháº¿ trá»±c quan:</h4>
        <div class="seat-map" id="seatMap"></div>
      </div>
      
      <button class="btn btn-success" onclick="datVe()">Äáº·t vÃ© ngay</button>
    </div>
  </div>

  <div id="veDaDatTab" class="tab-content">
    <div class="card">
      <h3>ğŸ“‹ VÃ© Ä‘Ã£ Ä‘áº·t</h3>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-sm" onclick="filterTickets('all')">Táº¥t cáº£</button>
        <button class="btn btn-sm btn-warning" onclick="filterTickets('pending')">ChÆ°a thanh toÃ¡n</button>
        <button class="btn btn-sm btn-success" onclick="filterTickets('paid')">ÄÃ£ thanh toÃ¡n</button>
      </div>
      <table id="bangVe">
        <thead>
          <tr>
            <th>Chuyáº¿n</th>
            <th>Gháº¿</th>
            <th>GiÃ¡ (VNÄ)</th>
            <th>NgÃ y Ä‘áº·t</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th>HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="thongTinTab" class="tab-content">
    <div class="card">
      <h3>ğŸ‘¤ ThÃ´ng tin tÃ i khoáº£n</h3>
      <div class="form-grid">
        <div class="form-group">
          <label for="infoUsername">TÃªn Ä‘Äƒng nháº­p</label>
          <input id="infoUsername" readonly>
        </div>
        <div class="form-group">
          <label for="infoFullName">Há» vÃ  tÃªn</label>
          <input id="infoFullName">
        </div>
        <div class="form-group">
          <label for="infoEmail">Email</label>
          <input id="infoEmail" type="email">
        </div>
        <div class="form-group">
          <label for="infoPhone">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
          <input id="infoPhone">
        </div>
      </div>
      <button class="btn btn-success" onclick="updateProfile()">Cáº­p nháº­t thÃ´ng tin</button>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <h4>Thá»‘ng kÃª cÃ¡ nhÃ¢n</h4>
        <div class="stats-container">
          <div class="stat-card">
            <h4>Tá»•ng sá»‘ vÃ©</h4>
            <div class="value" id="totalTickets">0</div>
          </div>
          <div class="stat-card">
            <h4>ÄÃ£ thanh toÃ¡n</h4>
            <div class="value" id="paidTickets">0</div>
          </div>
          <div class="stat-card">
            <h4>Tá»•ng chi tiÃªu</h4>
            <div class="value" id="totalSpent">0</div>
            <p>VNÄ</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ’³ Thanh toÃ¡n -->
<div id="paymentScreen" class="hidden">
  <div class="card" style="text-align:center;">
    <h3>ğŸ’³ Thanh toÃ¡n vÃ© tÃ u</h3>
    <p>Vui lÃ²ng chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n:</p>
    
    <div class="payment-methods">
      <div class="payment-method" onclick="selectPayment('credit')">
        <i>ğŸ’³</i>
        <p>Tháº» tÃ­n dá»¥ng</p>
      </div>
      <div class="payment-method" onclick="selectPayment('transfer')">
        <i>ğŸ¦</i>
        <p>Chuyá»ƒn khoáº£n</p>
      </div>
      <div class="payment-method" onclick="selectPayment('cash')">
        <i>ğŸ’µ</i>
        <p>Tiá»n máº·t</p>
      </div>
    </div>
    
    <div id="paymentDetails" class="hidden" style="margin: 20px 0; text-align: left;">
      <h4>ThÃ´ng tin thanh toÃ¡n:</h4>
      <p><strong>Chuyáº¿n tÃ u:</strong> <span id="payTrip"></span></p>
      <p><strong>Sá»‘ gháº¿:</strong> <span id="paySeat"></span></p>
      <p><strong>Sá»‘ tiá»n:</strong> <span id="payAmount"></span> VNÄ</p>
      <p><strong>PhÆ°Æ¡ng thá»©c:</strong> <span id="payMethod"></span></p>
    </div>
    
    <button class="btn btn-success" onclick="confirmPay()" id="confirmPayBtn">XÃ¡c nháº­n thanh toÃ¡n</button>
    <button class="btn" onclick="backToUser()">Quay láº¡i</button>
  </div>
</div>

<!-- ğŸ› ï¸ Trang quáº£n trá»‹ -->
<div id="adminScreen" class="hidden">
  <div class="card">
    <div class="card-header">
      <h3>ğŸ› ï¸ Quáº£n trá»‹ há»‡ thá»‘ng</h3>
      <button class="btn btn-danger" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>
    <p>ChÃ o má»«ng quáº£n trá»‹ viÃªn! DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c cÃ´ng cá»¥ quáº£n lÃ½ há»‡ thá»‘ng.</p>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchAdminTab('quanLyChuyenTab')">ğŸš† Quáº£n lÃ½ chuyáº¿n</div>
    <div class="tab" onclick="switchAdminTab('quanLyUserTab')">ğŸ‘¥ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</div>
    <div class="tab" onclick="switchAdminTab('caiDatTab')">âš™ï¸ CÃ i Ä‘áº·t há»‡ thá»‘ng</div>
    <div class="tab" onclick="switchAdminTab('thongKeTab')">ğŸ“Š Thá»‘ng kÃª</div>
  </div>

  <div id="quanLyChuyenTab" class="tab-content active">
    <div class="card">
      <h3>ğŸ“‹ Quáº£n lÃ½ chuyáº¿n tÃ u</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="soHieu">Sá»‘ hiá»‡u tÃ u</label>
          <input id="soHieu" placeholder="VD: SE1, TN2">
        </div>
        <div class="form-group">
          <label for="tuyen">Tuyáº¿n Ä‘Æ°á»ng</label>
          <input id="tuyen" placeholder="VD: HÃ  Ná»™i - SÃ i GÃ²n">
        </div>
        <div class="form-group">
          <label for="gia">GiÃ¡ vÃ© (VNÄ)</label>
          <input id="gia" type="number" placeholder="Nháº­p giÃ¡ vÃ©">
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="gioKhoiHanh">Giá» khá»Ÿi hÃ nh</label>
          <input id="gioKhoiHanh" type="time" value="08:00">
        </div>
        <div class="form-group">
          <label for="soLuongGhe">Sá»‘ lÆ°á»£ng gháº¿</label>
          <input id="soLuongGhe" type="number" placeholder="Sá»‘ gháº¿" value="50">
        </div>
        <div class="form-group">
          <label for="trangThaiTau">Tráº¡ng thÃ¡i tÃ u</label>
          <select id="trangThaiTau">
            <option value="Äang hoáº¡t Ä‘á»™ng">Äang hoáº¡t Ä‘á»™ng</option>
            <option value="Táº¡m dá»«ng">Táº¡m dá»«ng</option>
            <option value="Báº£o trÃ¬">Báº£o trÃ¬</option>
            <option value="Há»§y">Há»§y</option>
          </select>
        </div>
      </div>
      
      <button class="btn btn-success" onclick="themChuyenTau()">ThÃªm chuyáº¿n tÃ u</button>
    </div>

    <div class="card">
      <h3>ğŸ“‹ Danh sÃ¡ch chuyáº¿n tÃ u</h3>
      <table id="bangChuyen">
        <thead>
          <tr>
            <th>Sá»‘ hiá»‡u</th>
            <th>Tuyáº¿n</th>
            <th>Giá» khá»Ÿi hÃ nh</th>
            <th>Sá»‘ gháº¿</th>
            <th>GiÃ¡ (VNÄ)</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th>HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="quanLyUserTab" class="tab-content">
    <div class="card">
      <h3>ğŸ‘¥ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</h3>
      <table id="bangUsers">
        <thead>
          <tr>
            <th>TÃªn Ä‘Äƒng nháº­p</th>
            <th>Há» tÃªn</th>
            <th>Email</th>
            <th>Sá»‘ Ä‘iá»‡n thoáº¡i</th>
            <th>Vai trÃ²</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th>HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="caiDatTab" class="tab-content">
    <div class="card">
      <h3>âš™ï¸ CÃ i Ä‘áº·t há»‡ thá»‘ng</h3>
      
      <div class="form-group">
        <label for="tenCongTy">TÃªn cÃ´ng ty</label>
        <input id="tenCongTy" value="CÃ´ng ty ÄÆ°á»ng sáº¯t Viá»‡t Nam">
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="phiDichVu">PhÃ­ dá»‹ch vá»¥ (%)</label>
          <input id="phiDichVu" type="number" value="5" min="0" max="20">
        </div>
        <div class="form-group">
          <label for="thoiGianHuyVe">Thá»i gian há»§y vÃ© (phÃºt)</label>
          <input id="thoiGianHuyVe" type="number" value="30" min="0">
        </div>
      </div>
      
      <div class="form-group">
        <label for="thongBaoHeThong">ThÃ´ng bÃ¡o há»‡ thá»‘ng</label>
        <textarea id="thongBaoHeThong" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; min-height: 100px;" placeholder="Nháº­p thÃ´ng bÃ¡o há»‡ thá»‘ng..."></textarea>
      </div>
      
      <button class="btn btn-success" onclick="luuCaiDat()">LÆ°u cÃ i Ä‘áº·t</button>
    </div>
  </div>

  <div id="thongKeTab" class="tab-content">
    <div class="card">
      <h3>ğŸ“Š Thá»‘ng kÃª doanh thu</h3>
      <div class="stats-container">
        <div class="stat-card">
          <h4>Tá»•ng sá»‘ vÃ©</h4>
          <div class="value" id="soVe">0</div>
        </div>
        <div class="stat-card">
          <h4>Doanh thu</h4>
          <div class="value" id="tongTien">0</div>
          <p>VNÄ</p>
        </div>
        <div class="stat-card">
          <h4>VÃ© chÆ°a thanh toÃ¡n</h4>
          <div class="value" id="veChuaThanhToan">0</div>
        </div>
        <div class="stat-card">
          <h4>VÃ© Ä‘Ã£ thanh toÃ¡n</h4>
          <div class="value" id="veDaThanhToan">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ“ˆ Top chuyáº¿n tÃ u phá»• biáº¿n</h3>
      <table id="topChuyenTau">
        <thead>
          <tr>
            <th>Chuyáº¿n tÃ u</th>
            <th>Sá»‘ vÃ© bÃ¡n</th>
            <th>Doanh thu</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

</div>

<div id="notification" class="notification"></div>

<script>
// ======================= Dá»® LIá»†U =======================
let users = JSON.parse(localStorage.getItem("users") || "[]");
let chuyenTau = JSON.parse(localStorage.getItem("chuyenTau") || "[]");
let veTau = JSON.parse(localStorage.getItem("veTau") || "[]");
let caiDat = JSON.parse(localStorage.getItem("caiDat") || '{"tenCongTy":"CÃ´ng ty ÄÆ°á»ng sáº¯t Viá»‡t Nam","phiDichVu":5,"thoiGianHuyVe":30,"thongBaoHeThong":"ChÃ o má»«ng Ä‘áº¿n vá»›i há»‡ thá»‘ng Ä‘áº·t vÃ© tÃ u!"}');
let currentUser = JSON.parse(localStorage.getItem("loggedInUser") || "null");
let payIndex = null;
let selectedPaymentMethod = null;
let currentTicketFilter = 'all';

// Khá»Ÿi táº¡o dá»¯ liá»‡u máº«u náº¿u chÆ°a cÃ³
function initializeData() {
  if (users.length === 0) {
    users = [
      { 
        user: "admin", 
        pass: "123", 
        role: "admin",
        fullName: "Quáº£n trá»‹ viÃªn",
        email: "admin@railway.com",
        phone: "0123456789",
        status: "active",
        createdAt: new Date().toISOString()
      },
      { 
        user: "user", 
        pass: "123", 
        role: "user",
        fullName: "NgÆ°á»i dÃ¹ng Demo",
        email: "user@example.com",
        phone: "0987654321",
        status: "active",
        createdAt: new Date().toISOString()
      }
    ];
    localStorage.setItem("users", JSON.stringify(users));
  }

  if (chuyenTau.length === 0) {
    chuyenTau = [
      { 
        soHieu: "SE1", 
        tuyen: "HÃ  Ná»™i - SÃ i GÃ²n", 
        gia: "500000", 
        gioKhoiHanh: "08:00", 
        soLuongGhe: 50, 
        trangThai: "Äang hoáº¡t Ä‘á»™ng",
        createdAt: new Date().toISOString()
      },
      { 
        soHieu: "SE2", 
        tuyen: "SÃ i GÃ²n - HÃ  Ná»™i", 
        gia: "500000", 
        gioKhoiHanh: "14:00", 
        soLuongGhe: 50, 
        trangThai: "Äang hoáº¡t Ä‘á»™ng",
        createdAt: new Date().toISOString()
      },
      { 
        soHieu: "TN1", 
        tuyen: "HÃ  Ná»™i - Háº£i PhÃ²ng", 
        gia: "150000", 
        gioKhoiHanh: "07:30", 
        soLuongGhe: 40, 
        trangThai: "Äang hoáº¡t Ä‘á»™ng",
        createdAt: new Date().toISOString()
      },
      { 
        soHieu: "TN2", 
        tuyen: "Háº£i PhÃ²ng - HÃ  Ná»™i", 
        gia: "150000", 
        gioKhoiHanh: "16:00", 
        soLuongGhe: 40, 
        trangThai: "Táº¡m dá»«ng",
        createdAt: new Date().toISOString()
      }
    ];
    localStorage.setItem("chuyenTau", JSON.stringify(chuyenTau));
  }
}

// Gá»i hÃ m khá»Ÿi táº¡o dá»¯ liá»‡u
initializeData();

// ======================= HIá»‚N THá»Š THÃ”NG BÃO =======================
function showNotification(message, type = "info") {
  const notification = document.getElementById("notification");
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.classList.add("show");
  
  setTimeout(() => {
    notification.classList.remove("show");
  }, 3000);
}

// ======================= GIAO DIá»†N =======================
function show(screen) {
  ["loginScreen", "registerScreen", "userScreen", "paymentScreen", "adminScreen"].forEach(id => {
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(screen).classList.remove("hidden");
}

function showRegister() {
  show("registerScreen");
}

function showLogin() {
  show("loginScreen");
}

function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.getElementById(tabId).classList.add('active');
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  event.target.classList.add('active');
  
  if (tabId === 'veDaDatTab') {
    loadVe();
  } else if (tabId === 'thongTinTab') {
    loadUserInfo();
  } else if (tabId === 'datVeTab') {
    loadChuyenForUser();
  }
}

function switchAdminTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.getElementById(tabId).classList.add('active');
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  event.target.classList.add('active');
  
  if (tabId === 'thongKeTab') {
    loadAdminStats();
  } else if (tabId === 'caiDatTab') {
    loadCaiDat();
  } else if (tabId === 'quanLyUserTab') {
    loadUsers();
  }
}

// ======================= ÄÄ‚NG KÃ / ÄÄ‚NG NHáº¬P =======================
function register() {
  const username = document.getElementById('regUsername').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const confirmPassword = document.getElementById('regConfirmPassword').value.trim();
  const fullName = document.getElementById('regFullName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  
  if (!username || !password || !confirmPassword || !fullName || !email) {
    return showNotification("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!", "error");
  }
  
  if (password !== confirmPassword) {
    return showNotification("Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p!", "error");
  }
  
  if (users.find(u => u.user === username)) {
    return showNotification("TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i!", "error");
  }
  
  if (users.find(u => u.email === email)) {
    return showNotification("Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng!", "error");
  }
  
  const newUser = {
    user: username,
    pass: password,
    role: "user",
    fullName: fullName,
    email: email,
    phone: phone,
    status: "active",
    createdAt: new Date().toISOString()
  };
  
  users.push(newUser);
  localStorage.setItem("users", JSON.stringify(users));
  
  showNotification("ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.", "success");
  showLogin();
}

function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  
  console.log("Äang Ä‘Äƒng nháº­p vá»›i:", username, password);
  console.log("Danh sÃ¡ch users:", users);
  
  const user = users.find(u => u.user === username && u.pass === password);
  
  if (!user) {
    console.log("KhÃ´ng tÃ¬m tháº¥y user hoáº·c sai máº­t kháº©u");
    return showNotification("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u!", "error");
  }
  
  // Sá»¬A Lá»–I: Chá»‰ kiá»ƒm tra status cho user thÆ°á»ng, admin luÃ´n Ä‘Æ°á»£c Ä‘Äƒng nháº­p
  if (user.role !== "admin" && user.status !== "active") {
    return showNotification("TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a!", "error");
  }
  
  currentUser = user;
  localStorage.setItem("loggedInUser", JSON.stringify(user));
  
  console.log("ÄÄƒng nháº­p thÃ nh cÃ´ng:", user);
  
  if (user.role === "admin") {
    loadAdmin();
    showNotification(`ChÃ o má»«ng quáº£n trá»‹ viÃªn ${user.fullName || user.user}!`, "success");
  } else {
    loadUser();
    showNotification(`ChÃ o má»«ng ${user.fullName || user.user} Ä‘áº¿n vá»›i há»‡ thá»‘ng!`, "success");
  }
}

function logout() {
  localStorage.removeItem("loggedInUser");
  currentUser = null;
  show("loginScreen");
  showNotification("ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng!", "info");
}

// ======================= NGÆ¯á»œI DÃ™NG =======================
function loadUser() {
  show("userScreen");
  document.getElementById('userName').textContent = currentUser.fullName || currentUser.user;
  loadUserInfo();
  loadChuyenForUser();
  loadVe();
}

function loadChuyenForUser() {
  const chonChuyen = document.getElementById('chonChuyen');
  const activeTrains = chuyenTau.filter(c => c.trangThai === "Äang hoáº¡t Ä‘á»™ng");
  
  chonChuyen.innerHTML = activeTrains.map(c => 
    `<option value="${c.soHieu} - ${c.tuyen}" data-gia="${c.gia}">${c.soHieu} - ${c.tuyen} (${parseInt(c.gia).toLocaleString()} VNÄ) - ${c.gioKhoiHanh}</option>`
  ).join("");
  
  chonChuyen.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const gia = selectedOption.getAttribute('data-gia');
    document.getElementById('giaVe').value = gia;
    
    // Hiá»ƒn thá»‹ báº£n Ä‘á»“ gháº¿
    generateSeatMap();
  });
  
  if (chonChuyen.options.length > 0) {
    const gia = chonChuyen.options[0].getAttribute('data-gia');
    document.getElementById('giaVe').value = gia;
    generateSeatMap();
  }
}

function generateSeatMap() {
  const seatMap = document.getElementById('seatMap');
  const selectedTrain = document.getElementById('chonChuyen').value;
  
  if (!selectedTrain) {
    document.getElementById('seatSelection').classList.add('hidden');
    return;
  }
  
  // Láº¥y thÃ´ng tin chuyáº¿n tÃ u
  const train = chuyenTau.find(c => `${c.soHieu} - ${c.tuyen}` === selectedTrain);
  if (!train) return;
  
  // Táº¡o báº£n Ä‘á»“ gháº¿
  seatMap.innerHTML = '';
  const rows = Math.ceil(train.soLuongGhe / 10);
  let seatNumber = 1;
  
  for (let i = 0; i < rows; i++) {
    for (let j = 0; j < 10; j++) {
      if (seatNumber > train.soLuongGhe) break;
      
      const seatCode = `${String.fromCharCode(65 + i)}${seatNumber.toString().padStart(2, '0')}`;
      const isOccupied = veTau.some(v => v.chuyen === selectedTrain && v.ghe === seatCode);
      
      const seat = document.createElement('div');
      seat.className = `seat ${isOccupied ? 'occupied' : ''}`;
      seat.textContent = seatNumber;
      seat.title = `Gháº¿ ${seatCode}`;
      
      if (!isOccupied) {
        seat.addEventListener('click', () => {
          document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
          seat.classList.add('selected');
          document.getElementById('soGhe').value = seatCode;
        });
      }
      
      seatMap.appendChild(seat);
      seatNumber++;
    }
  }
  
  document.getElementById('seatSelection').classList.remove('hidden');
}

function loadUserInfo() {
  document.getElementById('infoUsername').value = currentUser.user;
  document.getElementById('infoFullName').value = currentUser.fullName || '';
  document.getElementById('infoEmail').value = currentUser.email || '';
  document.getElementById('infoPhone').value = currentUser.phone || '';
  
  // Thá»‘ng kÃª cÃ¡ nhÃ¢n
  const userTickets = veTau.filter(v => v.nguoi === currentUser.user);
  const paidTickets = userTickets.filter(v => v.trangThai === "ÄÃ£ thanh toÃ¡n");
  const totalSpent = paidTickets.reduce((sum, v) => sum + parseInt(v.gia), 0);
  
  document.getElementById('totalTickets').textContent = userTickets.length;
  document.getElementById('paidTickets').textContent = paidTickets.length;
  document.getElementById('totalSpent').textContent = totalSpent.toLocaleString();
}

function updateProfile() {
  const fullName = document.getElementById('infoFullName').value.trim();
  const email = document.getElementById('infoEmail').value.trim();
  const phone = document.getElementById('infoPhone').value.trim();
  
  if (!fullName || !email) {
    return showNotification("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!", "error");
  }
  
  // Cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng
  const userIndex = users.findIndex(u => u.user === currentUser.user);
  if (userIndex !== -1) {
    users[userIndex].fullName = fullName;
    users[userIndex].email = email;
    users[userIndex].phone = phone;
    
    // Cáº­p nháº­t currentUser
    currentUser.fullName = fullName;
    currentUser.email = email;
    currentUser.phone = phone;
    
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("loggedInUser", JSON.stringify(currentUser));
    
    showNotification("Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng!", "success");
    loadUserInfo();
  }
}

function datVe() {
  const ch = document.getElementById('chonChuyen').value;
  const ghe = document.getElementById('soGhe').value;
  const gia = document.getElementById('giaVe').value;
  
  if (!ch || !ghe || !gia) return showNotification("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!", "error");
  
  // Kiá»ƒm tra gháº¿ Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t chÆ°a
  const existingSeat = veTau.find(v => v.chuyen === ch && v.ghe === ghe);
  if (existingSeat) return showNotification("Gháº¿ nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t! Vui lÃ²ng chá»n gháº¿ khÃ¡c.", "error");
  
  veTau.push({ 
    nguoi: currentUser.user, 
    chuyen: ch, 
    ghe, 
    gia, 
    trangThai: "ChÆ°a thanh toÃ¡n",
    ngayDat: new Date().toLocaleDateString('vi-VN'),
    createdAt: new Date().toISOString()
  });
  
  localStorage.setItem("veTau", JSON.stringify(veTau));
  showNotification("Äáº·t vÃ© thÃ nh cÃ´ng! Vui lÃ²ng thanh toÃ¡n Ä‘á»ƒ xÃ¡c nháº­n.", "success");
  loadVe();
  generateSeatMap();
  
  // Reset form
  document.getElementById('soGhe').value = "";
  document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
}

function filterTickets(filter) {
  currentTicketFilter = filter;
  loadVe();
}

function loadVe() {
  const tb = document.querySelector("#bangVe tbody");
  let userTickets = veTau.filter(v => v.nguoi === currentUser.user);
  
  // Lá»c theo tráº¡ng thÃ¡i
  if (currentTicketFilter === 'pending') {
    userTickets = userTickets.filter(v => v.trangThai === "ChÆ°a thanh toÃ¡n");
  } else if (currentTicketFilter === 'paid') {
    userTickets = userTickets.filter(v => v.trangThai === "ÄÃ£ thanh toÃ¡n");
  }
  
  tb.innerHTML = "";
  
  if (userTickets.length === 0) {
    tb.innerHTML = `<tr><td colspan="6" style="text-align: center;">KhÃ´ng cÃ³ vÃ© nÃ o.</td></tr>`;
    return;
  }
  
  userTickets.forEach((v, i) => {
    const statusClass = v.trangThai === "ÄÃ£ thanh toÃ¡n" ? "status-confirmed" : "status-pending";
    
    tb.innerHTML += `
      <tr>
        <td>${v.chuyen}</td>
        <td>${v.ghe}</td>
        <td>${parseInt(v.gia).toLocaleString()}</td>
        <td>${v.ngayDat}</td>
        <td><span class="status-badge ${statusClass}">${v.trangThai}</span></td>
        <td>
          ${v.trangThai === "ChÆ°a thanh toÃ¡n" ? 
            `<button class="btn btn-sm btn-warning" onclick="mothanhToan(${i})">Thanh toÃ¡n</button>
             <button class="btn btn-sm btn-danger" onclick="huyVe(${i})">Há»§y vÃ©</button>` : 
            `<span class="status-badge status-paid">ÄÃ£ xÃ¡c nháº­n</span>`
          }
        </td>
      </tr>`;
  });
}

function huyVe(index) {
  if (confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n há»§y vÃ© nÃ y?")) {
    veTau.splice(index, 1);
    localStorage.setItem("veTau", JSON.stringify(veTau));
    showNotification("ÄÃ£ há»§y vÃ© thÃ nh cÃ´ng!", "success");
    loadVe();
    generateSeatMap();
  }
}

function mothanhToan(i) {
  payIndex = i;
  const ticket = veTau[payIndex];
  
  document.getElementById('payTrip').textContent = ticket.chuyen;
  document.getElementById('paySeat').textContent = ticket.ghe;
  document.getElementById('payAmount').textContent = parseInt(ticket.gia).toLocaleString();
  
  show("paymentScreen");
}

function backToUser() {
  payIndex = null;
  selectedPaymentMethod = null;
  document.querySelectorAll('.payment-method').forEach(method => {
    method.classList.remove('selected');
  });
  document.getElementById('paymentDetails').classList.add('hidden');
  document.getElementById('confirmPayBtn').disabled = true;
  
  show("userScreen");
}

// ======================= THANH TOÃN =======================
function selectPayment(method) {
  selectedPaymentMethod = method;
  
  document.querySelectorAll('.payment-method').forEach(m => {
    m.classList.remove('selected');
  });
  event.target.closest('.payment-method').classList.add('selected');
  
  document.getElementById('paymentDetails').classList.remove('hidden');
  
  let methodText = "";
  switch(method) {
    case 'credit': methodText = "Tháº» tÃ­n dá»¥ng"; break;
    case 'transfer': methodText = "Chuyá»ƒn khoáº£n ngÃ¢n hÃ ng"; break;
    case 'cash': methodText = "Tiá»n máº·t"; break;
  }
  document.getElementById('payMethod').textContent = methodText;
  
  document.getElementById('confirmPayBtn').disabled = false;
}

function confirmPay() {
  if (payIndex !== null && selectedPaymentMethod) {
    const btn = document.getElementById('confirmPayBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading"></span> Äang xá»­ lÃ½...';
    btn.disabled = true;
    
    setTimeout(() => {
      veTau[payIndex].trangThai = "ÄÃ£ thanh toÃ¡n";
      veTau[payIndex].phuongThuc = selectedPaymentMethod;
      veTau[payIndex].ngayThanhToan = new Date().toLocaleDateString('vi-VN');
      
      localStorage.setItem("veTau", JSON.stringify(veTau));
      
      btn.innerHTML = originalText;
      showNotification("Thanh toÃ¡n thÃ nh cÃ´ng! VÃ© cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n.", "success");
      
      show("userScreen");
      loadVe();
      loadUserInfo();
      generateSeatMap();
      
      payIndex = null;
      selectedPaymentMethod = null;
    }, 1500);
  }
}

// ======================= ADMIN =======================
function loadAdmin() {
  show("adminScreen");
  loadChuyen();
  loadAdminStats();
  loadCaiDat();
  loadUsers();
}

function loadCaiDat() {
  document.getElementById('tenCongTy').value = caiDat.tenCongTy;
  document.getElementById('phiDichVu').value = caiDat.phiDichVu;
  document.getElementById('thoiGianHuyVe').value = caiDat.thoiGianHuyVe;
  document.getElementById('thongBaoHeThong').value = caiDat.thongBaoHeThong || '';
}

function luuCaiDat() {
  caiDat.tenCongTy = document.getElementById('tenCongTy').value;
  caiDat.phiDichVu = parseInt(document.getElementById('phiDichVu').value);
  caiDat.thoiGianHuyVe = parseInt(document.getElementById('thoiGianHuyVe').value);
  caiDat.thongBaoHeThong = document.getElementById('thongBaoHeThong').value;
  
  localStorage.setItem("caiDat", JSON.stringify(caiDat));
  showNotification("ÄÃ£ lÆ°u cÃ i Ä‘áº·t há»‡ thá»‘ng!", "success");
}

function themChuyenTau() {
  const soHieuVal = document.getElementById('soHieu').value.trim();
  const tuyenVal = document.getElementById('tuyen').value.trim();
  const giaVal = document.getElementById('gia').value.trim();
  const gioKhoiHanhVal = document.getElementById('gioKhoiHanh').value;
  const soLuongGheVal = document.getElementById('soLuongGhe').value;
  const trangThaiVal = document.getElementById('trangThaiTau').value;
  
  if (!soHieuVal || !tuyenVal || !giaVal) {
    return showNotification("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!", "error");
  }
  
  if (chuyenTau.find(c => c.soHieu === soHieuVal)) {
    return showNotification("Sá»‘ hiá»‡u tÃ u Ä‘Ã£ tá»“n táº¡i!", "error");
  }
  
  chuyenTau.push({ 
    soHieu: soHieuVal, 
    tuyen: tuyenVal, 
    gia: giaVal,
    gioKhoiHanh: gioKhoiHanhVal,
    soLuongGhe: soLuongGheVal,
    trangThai: trangThaiVal,
    createdAt: new Date().toISOString()
  });
  
  localStorage.setItem("chuyenTau", JSON.stringify(chuyenTau));
  
  showNotification("ThÃªm chuyáº¿n tÃ u thÃ nh cÃ´ng!", "success");
  loadChuyen();
  
  // Reset form
  document.getElementById('soHieu').value = "";
  document.getElementById('tuyen').value = "";
  document.getElementById('gia').value = "";
}

function loadChuyen() {
  const tb = document.querySelector("#bangChuyen tbody");
  tb.innerHTML = "";
  
  if (chuyenTau.length === 0) {
    tb.innerHTML = `<tr><td colspan="7" style="text-align: center;">ChÆ°a cÃ³ chuyáº¿n tÃ u nÃ o.</td></tr>`;
    return;
  }
  
  chuyenTau.forEach((c, i) => {
    const statusClass = c.trangThai === "Äang hoáº¡t Ä‘á»™ng" ? "status-active" : 
                       c.trangThai === "Táº¡m dá»«ng" ? "status-pending" : "status-inactive";
    
    tb.innerHTML += `
      <tr>
        <td>${c.soHieu}</td>
        <td>${c.tuyen}</td>
        <td>${c.gioKhoiHanh}</td>
        <td>${c.soLuongGhe}</td>
        <td>${parseInt(c.gia).toLocaleString()}</td>
        <td><span class="status-badge ${statusClass}">${c.trangThai}</span></td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="thayDoiTrangThai(${i})">Äá»•i tráº¡ng thÃ¡i</button>
          <button class="btn btn-sm btn-danger" onclick="xoaChuyenTau(${i})">XÃ³a</button>
        </td>
      </tr>`;
  });
}

function thayDoiTrangThai(index) {
  const currentStatus = chuyenTau[index].trangThai;
  const statuses = ["Äang hoáº¡t Ä‘á»™ng", "Táº¡m dá»«ng", "Báº£o trÃ¬", "Há»§y"];
  const currentIndex = statuses.indexOf(currentStatus);
  const nextIndex = (currentIndex + 1) % statuses.length;
  
  chuyenTau[index].trangThai = statuses[nextIndex];
  localStorage.setItem("chuyenTau", JSON.stringify(chuyenTau));
  showNotification(`ÄÃ£ thay Ä‘á»•i tráº¡ng thÃ¡i thÃ nh: ${statuses[nextIndex]}`, "success");
  loadChuyen();
}

function xoaChuyenTau(index) {
  if (confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a chuyáº¿n tÃ u nÃ y?")) {
    // Kiá»ƒm tra xem cÃ³ vÃ© nÃ o Ä‘ang sá»­ dá»¥ng chuyáº¿n tÃ u nÃ y khÃ´ng
    const train = chuyenTau[index];
    const trainTickets = veTau.filter(v => v.chuyen === `${train.soHieu} - ${train.tuyen}`);
    
    if (trainTickets.length > 0) {
      return showNotification("KhÃ´ng thá»ƒ xÃ³a chuyáº¿n tÃ u Ä‘ang cÃ³ vÃ© Ä‘Ã£ Ä‘áº·t!", "error");
    }
    
    chuyenTau.splice(index, 1);
    localStorage.setItem("chuyenTau", JSON.stringify(chuyenTau));
    showNotification("ÄÃ£ xÃ³a chuyáº¿n tÃ u!", "success");
    loadChuyen();
  }
}

function loadUsers() {
  const tb = document.querySelector("#bangUsers tbody");
  tb.innerHTML = "";
  
  users.forEach((u, i) => {
    if (u.user === "admin") return; // KhÃ´ng hiá»ƒn thá»‹ tÃ i khoáº£n admin
    
    const statusClass = u.status === "active" ? "status-active" : "status-inactive";
    
    tb.innerHTML += `
      <tr>
        <td>${u.user}</td>
        <td>${u.fullName || 'ChÆ°a cáº­p nháº­t'}</td>
        <td>${u.email || 'ChÆ°a cáº­p nháº­t'}</td>
        <td>${u.phone || 'ChÆ°a cáº­p nháº­t'}</td>
        <td>${u.role === "admin" ? "Quáº£n trá»‹ viÃªn" : "NgÆ°á»i dÃ¹ng"}</td>
        <td><span class="status-badge ${statusClass}">${u.status === "active" ? "Hoáº¡t Ä‘á»™ng" : "KhÃ³a"}</span></td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="thayDoiTrangThaiUser(${i})">${u.status === "active" ? "KhÃ³a" : "Má»Ÿ khÃ³a"}</button>
          <button class="btn btn-sm btn-danger" onclick="xoaUser(${i})">XÃ³a</button>
        </td>
      </tr>`;
  });
}

function thayDoiTrangThaiUser(index) {
  users[index].status = users[index].status === "active" ? "inactive" : "active";
  localStorage.setItem("users", JSON.stringify(users));
  showNotification(`ÄÃ£ ${users[index].status === "active" ? "má»Ÿ khÃ³a" : "khÃ³a"} tÃ i khoáº£n!`, "success");
  loadUsers();
}

function xoaUser(index) {
  if (confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a ngÆ°á»i dÃ¹ng nÃ y?")) {
    const username = users[index].user;
    
    // Kiá»ƒm tra xem ngÆ°á»i dÃ¹ng cÃ³ vÃ© nÃ o khÃ´ng
    const userTickets = veTau.filter(v => v.nguoi === username);
    if (userTickets.length > 0) {
      return showNotification("KhÃ´ng thá»ƒ xÃ³a ngÆ°á»i dÃ¹ng Ä‘ang cÃ³ vÃ© Ä‘Ã£ Ä‘áº·t!", "error");
    }
    
    users.splice(index, 1);
    localStorage.setItem("users", JSON.stringify(users));
    showNotification("ÄÃ£ xÃ³a ngÆ°á»i dÃ¹ng!", "success");
    loadUsers();
  }
}

function loadAdminStats() {
  const daDat = veTau.filter(v => v.trangThai === "ÄÃ£ thanh toÃ¡n");
  const chuaThanhToan = veTau.filter(v => v.trangThai === "ChÆ°a thanh toÃ¡n");
  
  document.getElementById('soVe').textContent = veTau.length;
  document.getElementById('tongTien').textContent = daDat.reduce((t, v) => t + parseInt(v.gia), 0).toLocaleString();
  document.getElementById('veChuaThanhToan').textContent = chuaThanhToan.length;
  document.getElementById('veDaThanhToan').textContent = daDat.length;
  
  // Top chuyáº¿n tÃ u phá»• biáº¿n
  const trainStats = {};
  veTau.forEach(v => {
    if (!trainStats[v.chuyen]) {
      trainStats[v.chuyen] = { count: 0, revenue: 0 };
    }
    trainStats[v.chuyen].count++;
    if (v.trangThai === "ÄÃ£ thanh toÃ¡n") {
      trainStats[v.chuyen].revenue += parseInt(v.gia);
    }
  });
  
  const topTrains = Object.entries(trainStats)
    .sort((a, b) => b[1].count - a[1].count)
    .slice(0, 5);
  
  const topTrainsTable = document.querySelector("#topChuyenTau tbody");
  topTrainsTable.innerHTML = "";
  
  if (topTrains.length === 0) {
    topTrainsTable.innerHTML = `<tr><td colspan="3" style="text-align: center;">ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª.</td></tr>`;
    return;
  }
  
  topTrains.forEach(([train, stats]) => {
    topTrainsTable.innerHTML += `
      <tr>
        <td>${train}</td>
        <td>${stats.count}</td>
        <td>${stats.revenue.toLocaleString()} VNÄ</td>
      </tr>`;
  });
}

// ======================= KHá»I Äá»˜NG =======================
if (currentUser) {
  if (currentUser.role === "admin") loadAdmin();
  else loadUser();
} else {
  show("loginScreen");
}

// Xá»­ lÃ½ Enter Ä‘á»ƒ Ä‘Äƒng nháº­p
document.getElementById('password')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    login();
  }
});

document.getElementById('regConfirmPassword')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    register();
  }
});
</script>
</body>
</html>
